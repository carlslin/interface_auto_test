# 🚀 接口自动化测试框架 - 高级功能使用指南

## 📋 功能概览

本框架已经完整支持您需求的所有功能：

### ✅ 已实现的高级功能
- 🔐 **多种认证方式** - Bearer Token, API Key, OAuth2, Basic Auth
- 🔗 **依赖管理** - 智能识别和处理接口依赖关系
- 📝 **多格式支持** - Python, Postman, cURL, Insomnia等
- ⚠️ **登录提示** - 自动检测需要认证的接口并给出配置提示
- 📍 **配置位置指导** - 明确告知配置文件位置和格式
- 🎯 **依赖策略** - 针对复杂依赖场景的智能处理

## 🔐 认证管理功能

### 1. 支持的认证方式

#### Bearer Token认证
```yaml
# config/auth.yaml
authentication:
  api_auth:
    type: bearer
    login_url: "https://your-api.com/auth/login"
    username: "${AUTH_USERNAME}"
    password: "${AUTH_PASSWORD}"
    token_ttl: 24
    auto_refresh: true
```

#### API Key认证
```yaml
authentication:
  key_auth:
    type: api_key
    api_key: "${API_KEY}"
    header_name: "X-API-Key"
```

#### OAuth2认证
```yaml
authentication:
  oauth_auth:
    type: oauth2
    client_id: "${OAUTH_CLIENT_ID}"
    client_secret: "${OAUTH_CLIENT_SECRET}"
    token_url: "https://your-api.com/oauth/token"
    grant_type: "client_credentials"
```

### 2. 环境变量配置
```bash
# .env 文件
AUTH_USERNAME=your_username
AUTH_PASSWORD=your_password
API_KEY=your-api-key
OAUTH_CLIENT_ID=your_client_id
OAUTH_CLIENT_SECRET=your_client_secret
```

## 🔗 依赖管理功能

### 1. 工作流配置示例
```yaml
# config/workflow.yaml
workflow:
  scenarios:
    - name: "complete_user_workflow"
      steps:
        - id: "user_login"
          name: "用户登录"
          method: "POST"
          url: "${base_url}/auth/login"
          auth_required: false
          request_body:
            username: "${test_username}"
            password: "${test_password}"
          data_extraction:
            auth_token: "token"
            user_id: "user.id"
        
        - id: "get_user_profile"
          name: "获取用户资料"
          method: "GET"
          url: "${base_url}/users/${user_id}"
          auth_required: true
          dependencies: ["user_login"]
          dependency_type: "data"
          headers:
            Authorization: "Bearer @{user_login.extracted.auth_token}"
```

### 2. 依赖类型说明

#### 数据依赖 (data)
- 需要前置接口返回的数据（如用户ID、订单ID等）
- 使用 `@{step_id.extracted.field}` 语法引用

#### 认证依赖 (auth)
- 需要登录获取的Token或认证信息
- 自动传递认证头信息

#### 序列依赖 (sequence)
- 必须按特定顺序执行的操作
- 如：先创建资源，再更新，最后删除

## 🎯 使用示例

### 1. 从API文档生成高级测试

```bash
# 基础生成（包含认证检测）
python3 -m src.cli.main generate auto-complete \
  -i https://your-api.com/openapi.json \
  -w ./my_api_tests

# 生成的项目结构
my_api_tests/
├── config/
│   ├── auth.yaml          # 认证配置模板
│   ├── workflow.yaml      # 工作流配置
│   └── default.yaml       # 基础配置
├── tests/
│   └── generated/
│       └── test_api.py    # 生成的测试代码
├── exports/
│   └── test_cases.xlsx    # 测试用例文档
└── README.md              # 使用说明
```

### 2. 认证配置提示

当框架检测到需要认证的接口时，会自动提供配置提示：

```
🔐 检测到需要认证的接口:
   • POST /admin/users - URL模式表明需要认证
   • GET /user/profile - URL模式表明需要认证
   • PUT /user/settings - URL模式表明需要认证

⚠️ 认证配置建议:
   📁 配置文件位置: config/auth.yaml
   🔧 支持的认证方式: Bearer Token, API Key, OAuth2, Basic Auth
   🌍 环境变量配置: .env 文件
```

### 3. 依赖分析报告

框架会自动分析API依赖关系：

```markdown
## 🔗 依赖关系分析

### 潜在的依赖关系
- **PUT /users/{id}** 依赖于 **POST /users** - 修改/删除操作需要先创建资源
- **DELETE /orders/{id}** 依赖于 **POST /orders** - 修改/删除操作需要先创建资源

### 建议的测试工作流
1. **用户认证** - 获取访问令牌或建立会话
2. **基础数据查询** - 验证基础查询功能
3. **创建资源** - 创建测试数据
4. **更新和删除** - 验证数据修改功能
```

## 🛠️ 实际操作步骤

### 第一步：生成基础项目
```bash
python3 -m src.cli.main generate auto-complete \
  -i your_api_doc_url_or_file \
  -w ./advanced_api_tests
```

### 第二步：配置认证信息
```bash
# 编辑认证配置
vim advanced_api_tests/config/auth.yaml

# 或使用环境变量
cp advanced_api_tests/.env.template .env
vim .env
```

### 第三步：配置工作流依赖
```bash
# 根据需要修改工作流
vim advanced_api_tests/config/workflow.yaml
```

### 第四步：运行高级测试
```bash
cd advanced_api_tests
python tests/generated/test_api.py
```

## 📊 生成的多格式文件

### Python测试文件
```python
class AdvancedAPITest(BaseTest):
    def __init__(self):
        super().__init__()
        self.auth_manager = AuthManager("config/auth.yaml")
        self.dependency_manager = DependencyManager()
    
    def test_user_workflow(self):
        # 1. 执行认证
        auth_headers = self.auth_manager.get_auth_headers("api_auth")
        
        # 2. 执行依赖工作流
        success = self.dependency_manager.execute_workflow("user_workflow")
        
        # 3. 验证结果
        assert success, "工作流执行失败"
```

### Postman集合
```json
{
  "info": {
    "name": "API自动化测试集合",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/"
  },
  "auth": {
    "type": "bearer",
    "bearer": [{"key": "token", "value": "{{auth_token}}"}]
  },
  "item": [...]
}
```

### cURL脚本
```bash
#!/bin/bash
# API测试脚本

# 1. 用户登录获取Token
TOKEN=$(curl -s -X POST "$BASE_URL/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123"}' \
  | jq -r '.token')

# 2. 使用Token访问受保护接口
curl -X GET "$BASE_URL/user/profile" \
  -H "Authorization: Bearer $TOKEN"
```

## ⚠️ 安全和最佳实践

### 1. 敏感信息保护
- 使用环境变量存储密码和API密钥
- 不要将包含敏感信息的配置文件提交到版本控制
- 定期轮换API密钥和密码

### 2. 依赖管理策略
- 为CRUD操作建立正确的依赖关系
- 实现智能重试机制处理网络波动
- 添加数据清理步骤避免测试数据污染

### 3. 配置管理
- 为不同环境使用不同的认证配置
- 实施测试数据隔离
- 建立监控机制及时发现API变更

## 🎯 实战案例

### 案例1：电商API测试
```yaml
# 电商平台完整工作流
workflow:
  scenarios:
    - name: "ecommerce_workflow"
      steps:
        - id: "user_login"
          # 用户登录获取Token
        - id: "browse_products"
          # 浏览商品（需要认证）
        - id: "add_to_cart"
          # 添加到购物车（依赖商品数据）
        - id: "create_order"
          # 创建订单（依赖购物车数据）
        - id: "pay_order"
          # 支付订单（依赖订单数据）
        - id: "check_order_status"
          # 查询订单状态（依赖支付结果）
```

### 案例2：需要多步认证的API
```yaml
# 多步认证场景
authentication:
  two_factor_auth:
    type: "custom"
    steps:
      - login_with_password
      - verify_sms_code
      - get_final_token
```

## 🚀 高级技巧

### 1. 动态数据生成
```python
# 使用AI生成测试数据
self.test_data["email"] = generate_test_email()
self.test_data["phone"] = generate_test_phone()
```

### 2. 条件执行
```yaml
# 根据环境执行不同步骤
- id: "admin_operations"
  condition: "${environment} == 'test'"
  # 只在测试环境执行管理员操作
```

### 3. 并行执行
```yaml
# 支持并行执行的独立步骤
parallel_groups:
  - ["get_user_info", "get_user_orders", "get_user_favorites"]
```

## 📞 技术支持

如需更多帮助：
1. 查看完整文档：README.md
2. 查看示例项目：examples/ 目录
3. 运行演示：python3 quick_test_jsonplaceholder.py
4. 查看生成的项目：jsonplaceholder_automation/

---

🎉 **恭喜！您现在拥有了一个功能完整的高级接口自动化测试框架！**