# 测试模式选择功能使用指南

## 🎯 功能概述

接口自动化测试框架现在支持灵活的测试模式选择，可以根据实际情况在Mock模式和真实接口模式之间智能切换，大大提升了测试的灵活性和实用性。

## 🔧 支持的测试模式

### 1. Auto模式（自动选择）
- **特点**: 智能检测真实接口可用性，自动选择最佳模式
- **适用场景**: 
  - 开发阶段，网络环境不稳定
  - 需要根据环境自动适配的CI/CD流水线
  - 团队协作中不同开发者的环境差异

### 2. Mock模式（强制Mock）
- **特点**: 强制使用Mock服务器，不访问真实接口
- **适用场景**:
  - 离线开发和测试
  - 第三方接口不稳定或收费
  - 需要模拟特定场景和边界条件

### 3. Real模式（强制真实接口）
- **特点**: 强制使用真实接口，不使用Mock
- **适用场景**:
  - 集成测试和端到端测试
  - 生产环境验证
  - 需要真实数据和真实响应的测试

## 🚀 快速开始

### 1. 使用一键全自动完成（支持模式选择）

```bash
# 默认自动模式
python3 -m src.cli.main generate auto-complete --input api.yaml

# 指定Mock模式
python3 -m src.cli.main generate auto-complete --input api.yaml --test-mode mock

# 指定真实模式（跳过Mock）
python3 -m src.cli.main generate auto-complete --input api.yaml --skip-mock

# 指定真实模式
python3 -m src.cli.main generate auto-complete --input api.yaml --test-mode real
```

### 2. 管理测试模式

```bash
# 查看当前模式状态
python3 -m src.cli.main config show-mode

# 设置测试模式
python3 -m src.cli.main config set-mode --mode auto
python3 -m src.cli.main config set-mode --mode mock
python3 -m src.cli.main config set-mode --mode real

# 测试连通性
python3 -m src.cli.main config test-connectivity

# 为特定环境设置模式
python3 -m src.cli.main config set-mode --mode mock --environment dev
```

## ⚙️ 配置文件

### 全局配置
```yaml
global:
  test_mode: "auto"      # 默认测试模式
  mock_fallback: true    # 允许Mock回退

environments:
  dev:
    base_url: "http://dev-api.example.com"
    test_mode: "auto"    # 环境特定模式
  
  test:
    base_url: "http://test-api.example.com"
    test_mode: "real"    # 测试环境强制真实接口
  
  prod:
    base_url: "https://api.example.com"
    test_mode: "real"    # 生产环境强制真实接口
    mock_fallback: false # 禁用Mock回退

mock:
  port: 5000
  host: "localhost"
  auto_start: true       # 自动启动Mock服务器
```

## 💻 代码中使用

### 在测试代码中切换模式

```python
from src.core.base_test import BaseTest

class MyAPITest(BaseTest):
    def test_with_mode_switching(self):
        # 获取当前模式信息
        mode_info = self.get_current_mode_info()
        print(f"当前模式: {mode_info['test_mode']}")
        
        # 切换到Mock模式
        self.switch_to_mock_mode()
        result1 = self.make_request("GET", "/api/users")
        
        # 切换到真实模式
        self.switch_to_real_mode()
        result2 = self.make_request("GET", "/api/users")
        
        # 使用自动回退功能
        result3 = self.make_request_with_fallback("GET", "/api/health")
```

## 🎭 智能回退机制

当配置为auto模式或启用mock_fallback时，系统会自动处理请求失败：

1. **首次尝试**: 根据当前配置的模式发送请求
2. **失败检测**: 如果请求失败（网络错误、超时等）
3. **智能回退**: 自动切换到Mock模式重试
4. **结果返回**: 返回成功的结果，并标记使用的实际模式

## 📊 命令行工具

### 查看模式状态
```bash
$ python3 -m src.cli.main config show-mode

🔍 测试模式信息
==================================================
📋 当前环境: dev
🎯 测试模式: auto
🔄 Mock回退: 启用

🌐 URL信息:
  真实接口: http://dev-api.example.com
  Mock服务: http://localhost:5000
  有效URL: http://dev-api.example.com

🌍 当前将使用: 真实接口模式

📊 所有环境的模式设置:
  🟢 dev: auto (允许回退)
  ⚪ test: real (允许回退)
  ⚪ prod: real (禁止回退)
```

### 测试连通性
```bash
$ python3 -m src.cli.main config test-connectivity

🔍 测试环境 'dev' 的接口连通性
==================================================

🌍 测试真实接口: http://dev-api.example.com
  ✅ http://dev-api.example.com/health - 200 (0.15s)

🎭 测试Mock服务器: http://localhost:5000
  ✅ Mock服务器可用 - 200 (0.02s)

💡 建议:
  ✨ 建议使用 'auto' 模式，系统将智能选择
```

## 🔧 最佳实践

### 1. 开发阶段
- 使用`auto`模式，让系统自动适配
- 启用Mock服务器作为备选
- 配置合理的超时时间

### 2. 测试阶段
- CI/CD环境使用`real`模式确保真实性
- 功能测试使用`mock`模式提高稳定性
- 性能测试使用`real`模式获取真实数据

### 3. 生产环境
- 强制使用`real`模式
- 禁用Mock回退保证数据真实性
- 配置较短的超时时间

## 🎁 项目模板

使用一键全自动完成功能生成的项目将包含：

### Auto模式项目
- 智能配置文件，支持多种模式
- Mock服务器配置（备用）
- 详细的使用指南和模式管理命令

### Mock模式项目
- 预配置的Mock服务器
- 丰富的Mock数据模板
- 离线开发完整支持

### Real模式项目
- 真实接口配置模板
- 认证和权限设置指南
- 生产级配置示例

## 🆘 常见问题

### Q: 如何判断当前使用的是哪种模式？
A: 使用`config show-mode`命令或在代码中调用`get_current_mode_info()`方法。

### Q: Mock服务器启动失败怎么办？
A: 检查端口是否被占用，或使用`config test-connectivity`命令诊断问题。

### Q: 真实接口认证失败怎么办？
A: 检查配置文件中的认证信息，确保token或API密钥正确。

### Q: 如何在不同环境间切换？
A: 使用`config switch`命令或设置环境变量。

---

通过这些功能，您可以根据实际需求灵活选择测试模式，无论是开发阶段的快速迭代，还是生产环境的严格验证，都能找到合适的解决方案。