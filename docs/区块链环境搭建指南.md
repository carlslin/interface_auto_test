# 区块链环境搭建指南

## 📋 概述

本指南将帮助您搭建区块链测试环境，支持以太坊、比特币等主流区块链网络的测试。

## 🚀 快速开始

### 1. 安装依赖

```bash
# 激活虚拟环境
source venv/bin/activate

# 安装区块链依赖
pip install web3>=6.0.0 eth-account>=0.8.0 bitcoin>=1.1.42 pycryptodome>=3.18.0 mnemonic>=0.20
```

### 2. 配置网络连接

编辑 `config/blockchain.yaml` 文件：

```yaml
default_network: ethereum
default_env: sepolia

networks:
  ethereum:
    sepolia:
      name: "Ethereum Sepolia Testnet"
      rpc_url: "https://sepolia.infura.io/v3/YOUR_KEY"
      chain_id: 11155111
      explorer_url: "https://sepolia.etherscan.io"
      is_testnet: true
      gas_price_gwei: 1.0

  bitcoin:
    testnet:
      name: "Bitcoin Testnet"
      rpc_url: "http://user:pass@localhost:18332"
      explorer_url: "https://blockstream.info/testnet"
      is_testnet: true
```

### 3. 运行测试

```bash
# 运行所有区块链测试
python3 scripts/test_blockchain.py --all

# 测试特定网络
python3 scripts/test_blockchain.py --network ethereum --env sepolia

# 测试钱包功能
python3 scripts/test_blockchain.py --wallet-test
```

## 🌐 支持的区块链网络

### 以太坊生态

#### 主网
- **Ethereum Mainnet**
  - RPC: `https://mainnet.infura.io/v3/YOUR_KEY`
  - Chain ID: 1
  - Explorer: https://etherscan.io

- **BSC Mainnet**
  - RPC: `https://bsc-dataseed.binance.org`
  - Chain ID: 56
  - Explorer: https://bscscan.com

- **Polygon Mainnet**
  - RPC: `https://polygon-rpc.com`
  - Chain ID: 137
  - Explorer: https://polygonscan.com

#### 测试网
- **Ethereum Sepolia**
  - RPC: `https://sepolia.infura.io/v3/YOUR_KEY`
  - Chain ID: 11155111
  - Explorer: https://sepolia.etherscan.io

- **BSC Testnet**
  - RPC: `https://data-seed-prebsc-1-s1.binance.org:8545`
  - Chain ID: 97
  - Explorer: https://testnet.bscscan.com

### 比特币网络

#### 主网
- **Bitcoin Mainnet**
  - RPC: `http://localhost:8332`
  - Explorer: https://blockstream.info

#### 测试网
- **Bitcoin Testnet**
  - RPC: `http://localhost:18332`
  - Explorer: https://blockstream.info/testnet

- **Bitcoin Regtest**
  - RPC: `http://localhost:18443`
  - Explorer: Local

## 🔧 环境搭建

### 以太坊节点搭建

#### 使用 Infura/Alchemy（推荐）

1. 注册账户：
   - [Infura](https://infura.io/)
   - [Alchemy](https://www.alchemy.com/)

2. 创建项目获取API密钥

3. 配置RPC URL：
   ```
   https://sepolia.infura.io/v3/YOUR_PROJECT_ID
   ```

#### 本地节点搭建

使用 Docker 运行以太坊节点：

```bash
# 运行 Sepolia 测试网节点
docker run -d \
  --name ethereum-sepolia \
  -p 8545:8545 \
  -v ethereum-data:/root/.ethereum \
  ethereum/client-go:latest \
  --sepolia \
  --http \
  --http.addr 0.0.0.0 \
  --http.api eth,net,web3,personal,admin \
  --syncmode light
```

### 比特币节点搭建

#### 使用 Docker 运行 Bitcoin Core

```bash
# 运行 Bitcoin Testnet 节点
docker run -d \
  --name bitcoin-testnet \
  -p 18332:18332 \
  -p 18333:18333 \
  -v bitcoin-data:/home/bitcoin/.bitcoin \
  ruimarinho/bitcoin-core:latest \
  -testnet \
  -rpcallowip=0.0.0.0/0 \
  -rpcbind=0.0.0.0 \
  -rpcuser=user \
  -rpcpassword=password \
  -server \
  -txindex
```

#### 本地安装 Bitcoin Core

```bash
# macOS
brew install bitcoin

# 启动测试网节点
bitcoind -testnet -server -rpcuser=user -rpcpassword=password
```

## 💰 获取测试币

### 以太坊测试币

#### Sepolia 测试网
- [Sepolia Faucet](https://sepoliafaucet.com/)
- [Alchemy Faucet](https://sepoliafaucet.com/)

#### Goerli 测试网（已废弃）
- 注意：Goerli 测试网已废弃，建议使用 Sepolia

### 比特币测试币

#### 测试网水龙头
- [Bitcoin Testnet Faucet](https://testnet-faucet.mempool.co/)
- [Coinfaucet](https://coinfaucet.eu/en/btc-testnet/)

## 🔑 钱包管理

### 创建钱包

```python
from src.blockchain import WalletManager

# 创建钱包管理器
wallet_manager = WalletManager()

# 创建以太坊钱包
eth_wallet = await wallet_manager.create_wallet("ethereum", "我的钱包")

# 创建比特币钱包
btc_wallet = await wallet_manager.create_wallet("bitcoin", "我的钱包")

print(f"以太坊地址: {eth_wallet.address}")
print(f"比特币地址: {btc_wallet.address}")
```

### 导入私钥

```python
# 导入以太坊私钥
private_key = "0x..."
wallet = await wallet_manager.import_private_key(private_key, "ethereum")
```

### 导入助记词

```python
# 导入助记词
mnemonic = "abandon abandon abandon..."
wallet = await wallet_manager.import_mnemonic(mnemonic, "ethereum")
```

## 📝 智能合约测试

### 部署合约

```python
from src.blockchain import EthereumClient, SmartContractTester

# 创建客户端
client = EthereumClient(rpc_url, private_key)
tester = SmartContractTester(client)

# 部署合约
report = await tester.run_comprehensive_test(abi, bytecode)
```

### 测试合约方法

```python
# 测试合约方法
results = await tester.test_contract_methods(contract_address, abi)
```

## 🌐 跨链测试

### 使用区块链管理器

```python
from src.blockchain import BlockchainManager

# 创建管理器
manager = BlockchainManager()

# 添加网络
await manager.add_network("ethereum_sepolia", {
    "type": "ethereum",
    "rpc_url": "https://sepolia.infura.io/v3/YOUR_KEY",
    "is_testnet": True
})

# 运行跨链测试
results = await manager.run_cross_chain_test()
```

## 🔒 安全注意事项

### 私钥安全

1. **永远不要提交私钥到版本控制**
2. **使用环境变量存储敏感信息**
3. **在生产环境中使用硬件钱包**

```bash
# 使用环境变量
export ETHEREUM_PRIVATE_KEY="0x..."
export BITCOIN_RPC_PASSWORD="password"
```

### 测试网使用

1. **只使用测试网进行开发测试**
2. **不要在主网使用测试代码**
3. **定期清理测试数据**

## 📊 性能优化

### 连接池配置

```python
# 配置连接池
from web3 import Web3
from web3.middleware import geth_poa_middleware

w3 = Web3(Web3.HTTPProvider(rpc_url, request_kwargs={'timeout': 30}))
w3.middleware_onion.inject(geth_poa_middleware, layer=0)
```

### 批量操作

```python
# 批量创建钱包
wallets = []
for i in range(100):
    wallet = await wallet_manager.create_wallet("ethereum")
    wallets.append(wallet)
```

## 🐛 故障排除

### 常见问题

#### 1. 连接超时

```
错误: Connection timeout
解决: 检查网络连接和RPC URL
```

#### 2. 私钥格式错误

```
错误: Invalid private key format
解决: 确保私钥以0x开头，长度为66字符
```

#### 3. Gas费不足

```
错误: Insufficient gas
解决: 增加Gas限制或Gas价格
```

#### 4. 非ce余额不足

```
错误: Insufficient balance
解决: 从水龙头获取测试币
```

### 调试模式

```bash
# 启用详细日志
python3 scripts/test_blockchain.py --all --verbose
```

## 📚 进阶功能

### 自定义区块链支持

```python
# 添加自定义区块链
custom_config = {
    "type": "ethereum",
    "rpc_url": "https://custom-rpc.com",
    "chain_id": 999,
    "is_testnet": True
}

await manager.add_network("custom_chain", custom_config)
```

### 事件监听

```python
# 监听合约事件
async def event_callback(event):
    print(f"收到事件: {event}")

await client.listen_events(contract_address, abi, "Transfer", event_callback)
```

### 多重签名钱包

```python
# 创建多签钱包（需要额外配置）
multisig_wallet = await wallet_manager.create_multisig_wallet(
    signers=["0x...", "0x..."],
    threshold=2,
    blockchain_type="ethereum"
)
```

## 📖 参考资源

### 官方文档

- [Web3.py Documentation](https://web3py.readthedocs.io/)
- [Ethereum Developer Resources](https://ethereum.org/developers/)
- [Bitcoin Developer Documentation](https://developer.bitcoin.org/)

### 测试工具

- [Remix IDE](https://remix.ethereum.org/) - 智能合约开发
- [MetaMask](https://metamask.io/) - 浏览器钱包
- [MyEtherWallet](https://www.myetherwallet.com/) - 在线钱包

### 区块链浏览器

- [Etherscan](https://etherscan.io/) - 以太坊浏览器
- [BSCScan](https://bscscan.com/) - BSC浏览器
- [Blockstream](https://blockstream.info/) - 比特币浏览器

---

**注意**: 本指南仅用于开发和测试目的，请勿在生产环境中使用测试代码和私钥。
